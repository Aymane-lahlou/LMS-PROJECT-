{% extends 'base.html.twig' %}

{% block title %}Admin Dashboard{% endblock %}
{% block page_title %}Admin Dashboard{% endblock %}

{% block body %}
    <div class="row mb-4">
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.users }}</div><div>Utilisateurs</div></div><i class="bi bi-people fs-1 opacity-50"></i></div></div></div>
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.admins }}</div><div>Admins</div></div><i class="bi bi-shield-lock fs-1 opacity-50"></i></div></div></div>
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.teachers }}</div><div>Enseignants</div></div><i class="bi bi-person-video3 fs-1 opacity-50"></i></div></div></div>
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.students }}</div><div>Étudiants</div></div><i class="bi bi-mortarboard fs-1 opacity-50"></i></div></div></div>
    </div>
    <div class="row mb-4">
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.courses }}</div><div>Cours</div></div><i class="bi bi-journal-text fs-1 opacity-50"></i></div></div></div>
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.resources }}</div><div>Ressources</div></div><i class="bi bi-file-earmark-pdf fs-1 opacity-50"></i></div></div></div>
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.quizzes }}</div><div>Quiz</div></div><i class="bi bi-question-circle fs-1 opacity-50"></i></div></div></div>
        <div class="col-md-3"><div class="stats-card"><div class="d-flex justify-content-between align-items-center"><div><div class="stats-number">{{ kpis.attempts }}</div><div>Tentatives</div></div><i class="bi bi-graph-up fs-1 opacity-50"></i></div></div></div>
    </div>

    <!-- User management moved to dedicated section -->

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Cours par spécialité</h5>
                </div>
                <div class="card-body">
                    <canvas id="coursesBySpecialtyChart" height="120"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Spécialités</h5>
                </div>
                <div class="card-body">
                    {% if topSpecialty %}
                        <p class="mb-2"><strong>Spécialité la plus représentée :</strong> {{ topSpecialty.specialty }} ({{ topSpecialty.total }})</p>
                    {% endif %}
                    <h6 class="mt-3">Étudiants par spécialité</h6>
                    <ul class="list-group list-group-flush">
                        {% for row in studentsBySpecialty %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ row.specialty ?: 'Non renseignée' }}</span>
                                <span class="badge bg-primary">{{ row.total }}</span>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">Aucune donnée</li>
                        {% endfor %}
                    </ul>
                    <h6 class="mt-3">Étudiants par année</h6>
                    <ul class="list-group list-group-flush">
                        {% for row in studentsByYear %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ row.year ?: 'Non renseignée' }}</span>
                                <span class="badge bg-info text-dark">{{ row.total }}</span>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">Aucune donnée</li>
                        {% endfor %}
                    </ul>
                    <h6 class="mt-3">Lecture & complétion</h6>
                    <p class="mb-1">Progressions totalisées : {{ resourceStats.totalProgress }}</p>
                    <p class="mb-1">Ressources complétées : {{ resourceStats.completedProgress }}</p>
                    <p class="mb-0">Temps moyen de lecture (s) : {{ resourceStats.averageTime|number_format(0) }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Cours</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 mb-3">
                <div class="col-md-4">
                    <input type="text" name="q" value="{{ filters.q }}" class="form-control" placeholder="Recherche titre/description">
                </div>
                <div class="col-md-4">
                    <select name="specialty" class="form-select">
                        <option value="">Toutes les spécialités</option>
                        {% for label, value in specialties %}
                            <option value="{{ value }}" {{ filters.specialty == value ? 'selected' : '' }}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="year" class="form-select">
                        <option value="">Toutes les années</option>
                        {% for label, value in studyYears %}
                            <option value="{{ value }}" {{ filters.year == value ? 'selected' : '' }}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary"><i class="bi bi-search me-1"></i>Filtrer</button>
                </div>
            </form>
            <div class="row">
                {% for course in courses %}
                    <div class="col-md-4">
                        <div class="card course-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">{{ course.title }}</h6>
                                <p class="text-muted mb-1">{{ course.specialty }} • {{ course.targetYear }}</p>
                                <p class="mb-2"><i class="bi bi-person-video3 me-1"></i>{{ course.teacher.email }}</p>
                                <p class="small text-muted mb-1"><i class="bi bi-people me-1"></i>{{ courseEnrollmentCounts[course.id] ?? 0 }} inscrits</p>
                                <p class="small text-muted mb-0">{{ course.description }}</p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info mb-0">Aucun cours trouvé avec ces filtres.</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const chartData = {{ chartCoursesBySpecialty|json_encode|raw }};
        const labels = chartData.map(item => item.specialty || 'N/C');
        const values = chartData.map(item => parseInt(item.total, 10));
        const ctx = document.getElementById('coursesBySpecialtyChart');
        if (ctx && labels.length) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cours',
                        data: values,
                        backgroundColor: 'rgba(67,97,238,0.6)',
                        borderColor: '#3f37c9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, precision: 0 } }
                }
            });
        }
    </script>
{% endblock %}
